version: '3.8'

services:
  app:
    image: woolensheep/md2report:latest
    ports:
      - "8004:8000"
    command: uvicorn --host 0.0.0.0 main:app --workers 4
    restart: always
    volumes:
      - ./tmp:/tmp/md2report   # ← 改为相对路径
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - redis

  worker:
    image: woolensheep/md2report:latest
    command: celery -A main.celery worker --loglevel=info
    restart: always
    volumes:
      - ./tmp:/tmp/md2report   # ← 同步修改
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - redis

  redis:
    image: redis:7.0.5-alpine3.16
    restart: always
    # 可选：若不需要从外部直连 Redis，可注释掉 ports（更安全）
    # ports:
    #   - "6378:6379"
    volumes:
      - ./data/redis:/data     # ← 改为相对路径
    command: redis-server --appendonly yes  # 启用 AOF 持久化（更安全）
